{% extends 'base.html' %}

{% block title %}{{ accommodation.name }} - HorizonStays{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <div style="margin: var(--spacing-sm) 0;">
        <a href="{{ url_for('aco.home') }}" class="text-muted">Home</a> <span class="text-muted">/</span>
        <span class="text-main">{{ accommodation.name }}</span>
    </div>

    <!-- Hotel Header -->
    <div class="card" style="margin-bottom: var(--spacing-lg);">
        <div style="height: 300px; background-color: #ddd; position: relative;">
            {% if accommodation.image_url %}
            <img src="{{ url_for('static', filename=accommodation.image_url) }}" alt="{{ accommodation.name }}"
                style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <img src="https://placehold.co/1200x400?text={{ accommodation.name }}" alt="{{ accommodation.name }}"
                style="width: 100%; height: 100%; object-fit: cover;">
            {% endif %}
            <div
                style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: var(--spacing-md); color: white;">
                <h1 style="margin: 0; font-size: 2.5rem;">{{ accommodation.name }}</h1>
                <p style="margin: 0; font-size: 1.1rem; opacity: 0.9;"><i class="fa-solid fa-map-pin"></i> {{
                    accommodation.address }}</p>
            </div>
        </div>
        <div class="card-body">
            <div class="flex justify-between items-center">
                <div>
                    <span class="badge badge-accent" style="font-size: 1rem; padding: 0.5rem 1rem;">
                        <i class="fa-solid fa-star"></i> {{ accommodation.stars_quality }} Stars
                    </span>
                    <span class="badge badge-primary"
                        style="font-size: 1rem; padding: 0.5rem 1rem; margin-left: 0.5rem;">
                        {{ accommodation.type|capitalize }}
                    </span>
                </div>
                <div>
                    {% if accommodation.web %}
                    <a href="{{ accommodation.web }}" target="_blank" class="btn btn-outline"><i
                            class="fa-solid fa-globe"></i> Website</a>
                    {% endif %}
                    <a href="tel:{{ accommodation.phoneNumber }}" class="btn btn-outline"><i
                            class="fa-solid fa-phone"></i> {{ accommodation.phoneNumber }}</a>
                </div>
            </div>

            <hr style="margin: var(--spacing-md) 0; border-color: var(--border-color);">

            <h3>About this stay</h3>
            <p class="text-muted" style="margin-top: var(--spacing-sm);">{{ accommodation.description }}</p>
        </div>
    </div>

    <!-- Availability / Rooms Config -->
    <div style="margin-bottom: var(--spacing-lg);">
        <h2 style="margin-bottom: var(--spacing-md);">Available Rooms</h2>

        <!-- Search Dates Update Form -->
        <div class="card"
            style="padding: var(--spacing-md); margin-bottom: var(--spacing-md); background-color: #F9FAFB;">
            <form action="{{ url_for('aco.show', id=accommodation.id) }}" method="GET" class="flex items-end gap-4">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label class="form-label">Check-in</label>
                    <input type="date" name="checkin" class="form-control" value="{{ checkin or '' }}" required>
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label class="form-label">Check-out</label>
                    <input type="date" name="checkout" class="form-control" value="{{ checkout or '' }}" required>
                </div>
                <button type="submit" class="btn btn-outline">Update Dates</button>
            </form>
        </div>

        <div class="grid grid-cols-3">
            {% for room in accommodation.rooms %}
            {% set is_unavailable = room.id in unavailable_room_ids %}
            <div class="card" {% if is_unavailable %}style="opacity: 0.6;" {% endif %}>
                <img src="https://placehold.co/400x250?text=Room+{{ room.roomNumber }}" alt="Room" class="card-img"
                    style="height: 200px;">
                <div class="card-body">
                    <h3 class="card-title">{{ room.type }}</h3>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: var(--spacing-sm);">
                        <span class="badge"><i class="fa-solid fa-user"></i> {{ room.capacity }} Guests</span>
                        <span class="badge"><i class="fa-solid fa-door-open"></i> No. {{ room.roomNumber }}</span>
                    </div>

                    <div class="flex justify-between items-center" style="margin-top: var(--spacing-md);">
                        <div>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${{
                                room.priceNight }}</span>
                            <span class="text-muted" style="font-size: 0.875rem;">/ night</span>
                        </div>

                        {% if is_unavailable %}
                        <span class="badge"
                            style="background-color: #fee2e2; color: #991b1b; padding: 0.4rem 0.8rem;">Booked</span>
                        {% elif g.user %}
                        <button onclick="openBookingModal('{{ room.id }}', '{{ room.type }}', '{{ room.priceNight }}')"
                            class="btn btn-primary">
                            Book Now
                        </button>
                        {% else %}
                        <a href="{{ url_for('login') }}" class="btn btn-outline">Login to Book</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1 / -1; text-align: center; padding: var(--spacing-xl);">
                <p class="text-muted">No rooms available for this accommodation.</p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- Reviews Sidebar Button (Fixed Position Right) -->
<button id="reviewsToggleBtn" onclick="toggleReviewsSidebar()" 
    style="position: fixed; right: 20px; top: 50%; transform: translateY(-50%); z-index: 999; 
           background: var(--primary); color: white; border: none; border-radius: 50px; 
           padding: 1rem 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
           display: flex; align-items: center; gap: 0.5rem; font-weight: 600; transition: all 0.3s;
           font-size: 0.9rem;">
    <i class="fa-solid fa-comments"></i>
    <span class="reviews-btn-text">Reviews</span>
    {% if reviews|length > 0 %}
    <span style="background: rgba(255,255,255,0.3); padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
        {{ reviews|length }}
    </span>
    {% endif %}
</button>

<!-- Reviews Sidebar Panel -->
<div id="reviewsSidebar" 
    style="position: fixed; right: -100%; top: 0; width: 400px; max-width: 90vw; height: 100vh; 
           background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.1); z-index: 1000;
           transition: right 0.3s ease-in-out; overflow-y: auto; display: flex; flex-direction: column;">
    
    <!-- Sidebar Header -->
    <div style="padding: var(--spacing-lg); border-bottom: 2px solid var(--border-color); 
                background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 1.5rem;">
            <i class="fa-solid fa-comments"></i> Reviews
        </h2>
        <button onclick="toggleReviewsSidebar()" 
            style="background: rgba(255,255,255,0.2); border: none; color: white; 
                   width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">
            칑
        </button>
    </div>

    <!-- Sidebar Content -->
    <div style="flex: 1; padding: var(--spacing-md); overflow-y: auto;">
        
        <!-- Create Review Form -->
        {% if g.user %}
        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="card-body">
                <h3 style="margin-bottom: var(--spacing-md); font-size: 1.1rem;">Escribe una rese침a</h3>
                <form action="{{ url_for('booking.add_review') }}" method="POST" id="reviewForm">
                    <input type="hidden" name="idUser" value="{{ g.user.id }}">
                    <input type="hidden" name="idAccommodation" value="{{ accommodation.id }}">
                    
                    <div class="form-group" style="margin-bottom: var(--spacing-md);">
                        <label class="form-label">Calificaci칩n</label>
                        <div style="display: flex; gap: 0.5rem; font-size: 1.5rem;">
                            {% for i in range(1, 6) %}
                            <label style="cursor: pointer;">
                                <input type="radio" name="ratingStars" value="{{ i }}" required style="display: none;">
                                <i class="fa-regular fa-star star-rating" 
                                   data-rating="{{ i }}" 
                                   onclick="selectRating({{ i }})"
                                   style="color: #ddd; transition: color 0.2s;"></i>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: var(--spacing-md);">
                        <label for="reviewComment" class="form-label">Comentario</label>
                        <textarea id="reviewComment" name="reviewComment" class="form-control" rows="4" 
                                  placeholder="Comparte tu experiencia..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fa-solid fa-paper-plane"></i> Enviar Rese침a
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="card" style="margin-bottom: var(--spacing-lg); background: #f9fafb;">
            <div class="card-body" style="text-align: center;">
                <p class="text-muted">Debes iniciar sesi칩n para escribir una rese침a</p>
                <a href="{{ url_for('login') }}" class="btn btn-outline btn-sm">Iniciar Sesi칩n</a>
            </div>
        </div>
        {% endif %}

        <!-- Reviews List -->
        <div>
            <h3 style="margin-bottom: var(--spacing-md); font-size: 1.1rem;">
                Rese침as ({{ reviews|length }})
            </h3>
            
            {% if reviews %}
            <div style="display: flex; flex-direction: column; gap: var(--spacing-md);">
                {% for review in reviews %}
                <div class="card">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-sm);">
                            <div>
                                <strong style="font-size: 0.9rem;">
                                    {% if review.user %}
                                        {{ review.user.username }}
                                    {% else %}
                                        Usuario #{{ review.idUser }}
                                    {% endif %}
                                </strong>
                                <div style="margin-top: 0.25rem;">
                                    {% for i in range(1, 6) %}
                                        {% if i <= review.ratingStars %}
                                        <i class="fa-solid fa-star" style="color: #fbbf24; font-size: 0.8rem;"></i>
                                        {% else %}
                                        <i class="fa-regular fa-star" style="color: #ddd; font-size: 0.8rem;"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="text-muted" style="font-size: 0.75rem;">
                                {{ review.createdAt.strftime('%d/%m/%Y') if review.createdAt else '' }}
                            </span>
                        </div>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-main);">
                            {{ review.reviewComment }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card" style="background: #f9fafb;">
                <div class="card-body" style="text-align: center; padding: var(--spacing-lg);">
                    <i class="fa-solid fa-comment-slash" style="font-size: 2rem; color: var(--text-muted); margin-bottom: var(--spacing-sm);"></i>
                    <p class="text-muted">A칰n no hay rese침as para este alojamiento</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Overlay for sidebar -->
<div id="reviewsOverlay" onclick="toggleReviewsSidebar()" 
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
           background: rgba(0,0,0,0.3); z-index: 999; transition: opacity 0.3s;"></div>

<script>
    function toggleReviewsSidebar() {
        const sidebar = document.getElementById('reviewsSidebar');
        const overlay = document.getElementById('reviewsOverlay');
        const isOpen = sidebar.style.right === '0px' || sidebar.style.right === '';
        
        if (isOpen) {
            sidebar.style.right = '-100%';
            overlay.style.display = 'none';
        } else {
            sidebar.style.right = '0px';
            overlay.style.display = 'block';
        }
    }
    
    // Responsive: hide text on small screens
    function handleResize() {
        const btn = document.getElementById('reviewsToggleBtn');
        const text = btn.querySelector('.reviews-btn-text');
        if (window.innerWidth < 600) {
            if (text) text.style.display = 'none';
        } else {
            if (text) text.style.display = 'inline';
        }
    }
    
    window.addEventListener('resize', handleResize);
    handleResize(); // Initial check

    function selectRating(rating) {
        // Update radio button
        document.querySelector(`input[name="ratingStars"][value="${rating}"]`).checked = true;
        
        // Update star display
        const stars = document.querySelectorAll('.star-rating');
        stars.forEach((star, index) => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= rating) {
                star.classList.remove('fa-regular');
                star.classList.add('fa-solid');
                star.style.color = '#fbbf24';
            } else {
                star.classList.remove('fa-solid');
                star.classList.add('fa-regular');
                star.style.color = '#ddd';
            }
        });
    }

    // Initialize star ratings if form is submitted with errors
    document.addEventListener('DOMContentLoaded', function() {
        const selectedRating = document.querySelector('input[name="ratingStars"]:checked');
        if (selectedRating) {
            selectRating(parseInt(selectedRating.value));
        }
        
        // Auto-open sidebar if there's a success message (after creating review)
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'success' %}
                    setTimeout(function() { toggleReviewsSidebar(); }, 300);
                {% endif %}
            {% endfor %}
        {% endif %}
        {% endwith %}
    });

    // Handle form submission - reload sidebar after submit
    document.getElementById('reviewForm')?.addEventListener('submit', function(e) {
        // Form will submit normally, page will reload with new review
    });
</script>


<!-- Booking Modal -->
{% if g.user %}
<div id="bookingModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="card" style="width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h3 class="card-title" style="margin: 0;">Confirm Booking</h3>
                <button onclick="closeBookingModal()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <form action="{{ url_for('booking.book_accommodation') }}" method="POST">
                <input type="hidden" name="userId" value="{{ g.user.id }}">
                <input type="hidden" name="accommodationId" value="{{ accommodation.id }}">
                <input type="hidden" name="roomId" id="modalRoomId">
                <input type="hidden" name="totalPrice" id="modalTotalPriceInput">

                <div
                    style="background: var(--bg-body); padding: var(--spacing-sm); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                    <p><strong>Room:</strong> <span id="modalRoomType"></span></p>
                    <p><strong>Price:</strong> $<span id="modalPriceNight"></span> / night</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Check-in</label>
                    <input type="date" name="startDate" id="modalStartDate" class="form-control"
                        value="{{ checkin or '' }}" required onchange="calculateTotal()">
                </div>
                <div class="form-group">
                    <label class="form-label">Check-out</label>
                    <input type="date" name="endDate" id="modalEndDate" class="form-control"
                        value="{{ checkout or '' }}" required onchange="calculateTotal()">
                </div>

                <div style="margin: var(--spacing-md) 0; font-size: 1.1rem; font-weight: 700; text-align: right;">
                    Total: $<span id="modalTotalPrice">0.00</span>
                </div>

                <div class="flex gap-4">
                    <button type="button" onclick="closeBookingModal()" class="btn btn-outline"
                        style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Confirm Booking</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let currentPriceNight = 0;

    function openBookingModal(roomId, roomType, priceNight) {
        document.getElementById('bookingModal').style.display = 'flex';
        document.getElementById('modalRoomId').value = roomId;
        document.getElementById('modalRoomType').innerText = roomType;
        document.getElementById('modalPriceNight').innerText = priceNight;
        currentPriceNight = parseFloat(priceNight);

        // Evitar fechas pasadas en check-in
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('modalStartDate').min = today;
        document.getElementById('modalEndDate').min = today;

        calculateTotal();
    }

    function closeBookingModal() {
        document.getElementById('bookingModal').style.display = 'none';
    }

    function calculateTotal() {
        const startInput = document.getElementById('modalStartDate');
        const endInput = document.getElementById('modalEndDate');
        const start = startInput.value;
        const end = endInput.value;
        const totalSpan = document.getElementById('modalTotalPrice');
        const totalInput = document.getElementById('modalTotalPriceInput');

        // 游 Clave: impedir que el checkout sea anterior al checkin
        if (start) {
            endInput.min = start;
        }

        if (start && end) {
            const startDate = new Date(start);
            const endDate = new Date(end);

            // Si el usuario intenta poner una fecha inv치lida, la corregimos
            if (endDate <= startDate) {
                totalSpan.innerText = "0.00 (Select valid dates)";
                totalInput.value = 0;
                return;
            }

            const diffTime = endDate - startDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const total = (diffDays * currentPriceNight).toFixed(2);
            totalSpan.innerText = total;
            totalInput.value = total;
        }
    }

    window.onclick = function (event) {
        const modal = document.getElementById('bookingModal');
        if (event.target == modal) {
            closeBookingModal();
        }
    }
</script>

{% endif %}
{% endblock %}